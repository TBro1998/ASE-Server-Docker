name: ARK Server Docker Image CI

on:
  push:
    tags:
      - 'v*'

jobs:
  # # 只包含方舟服务器的基础镜像-ubuntu-2204
  # arkserver-base-ubuntu-2204:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
    
  #   - name: Login to DockerHub
  #     uses: docker/login-action@v3
  #     with:
  #       username: ${{ secrets.DOCKERHUB_USERNAME }}
  #       password: ${{ secrets.DOCKERHUB_TOKEN }}
    
  #   - name: Build the Docker image
  #     run: cd arkserver-base/ubuntu-2204 && docker build . --file dockerfile -t ${{ secrets.DOCKERHUB_USERNAME }}/arkserver-base:ubuntu-2204
    
  #   - name: Push Docker images
  #     run: cd arkserver-base/ubuntu-2204 && docker push ${{ secrets.DOCKERHUB_USERNAME }}/arkserver-base:ubuntu-2204

  # # 只包含方舟服务器的基础镜像-ubuntu-latest
  # arkserver-base-ubuntu-latest:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
    
  #   - name: Login to DockerHub
  #     uses: docker/login-action@v3
  #     with:
  #       username: ${{ secrets.DOCKERHUB_USERNAME }}
  #       password: ${{ secrets.DOCKERHUB_TOKEN }}
    
  #   - name: Build the Docker image
  #     run: cd arkserver-base/ubuntu-latest && docker build . --file dockerfile -t ${{ secrets.DOCKERHUB_USERNAME }}/arkserver-base:ubuntu-latest
    
  #   - name: Push Docker images
  #     run: cd arkserver-base/ubuntu-latest && docker push ${{ secrets.DOCKERHUB_USERNAME }}/arkserver-base:ubuntu-latest
  
  
  # # 只包含方舟服务器的基础镜像-steamcmd
  # arkserver-base-steamcmd:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
    
  #   - name: Login to DockerHub
  #     uses: docker/login-action@v3
  #     with:
  #       username: ${{ secrets.DOCKERHUB_USERNAME }}
  #       password: ${{ secrets.DOCKERHUB_TOKEN }}
    
  #   - name: Build the Docker image
  #     run: cd arkserver-base/steamcmd && docker build . --file dockerfile -t ${{ secrets.DOCKERHUB_USERNAME }}/arkserver-base:steamcmd
    
  #   - name: Push Docker images
  #     run: cd arkserver-base/steamcmd && docker push ${{ secrets.DOCKERHUB_USERNAME }}/arkserver-base:steamcmd

  # 最终镜像
  arkserver:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build the Docker image
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        docker build . --file dockerfile -t ${{ secrets.DOCKERHUB_USERNAME }}/arkserver:latest -t ${{ secrets.DOCKERHUB_USERNAME }}/arkserver:$TAG
    
    - name: Push Docker images
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/arkserver:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/arkserver:$TAG
